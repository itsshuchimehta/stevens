/* SHUCHI PARAGBHAI MEHTA CWID: 20009083 */

--------------------- Query 1

WITH CUST_Q AS(
	SELECT cust,MIN(quant) as MIN_Q,MAX(quant) AS MAX_Q,ROUND(AVG(quant) , 0) as AVG_Q
	FROM sales
	GROUP BY cust
),
CUST_MIN_Q AS(
	SELECT S.prod AS MIN_PROD,C.cust,S.month,S.day,S.year,S.state AS ST
	FROM CUST_Q C,sales S
	where S.cust=C.cust AND C.MIN_Q=S.quant), 
CUST_MAX_Q AS(
	SELECT S.prod AS MAX_PROD,S.cust,S.month,S.day,S.year,S.state AS ST
	FROM CUST_Q C,sales S
	where S.cust=C.cust AND C.MAX_Q=S.quant
)

SELECT C3.cust,C3.MIN_Q,C1.MIN_PROD,C1.month,C1.day,C1.year,C1.ST,C3.MAX_Q,C2.MAX_PROD,C2.month,C2.day,C2.year,C2.ST,C3.AVG_Q
FROM CUST_MIN_Q C1,CUST_MAX_Q C2,CUST_Q C3
WHERE C3.cust=C1.cust AND C3.cust=C2.cust
order by C3.cust;

--------------------- Query 2 

WITH Q1 AS(
	SELECT DISTINCT year,month,day,SUM(quant)AS TOTAL_Q
	FROM sales 
	GROUP BY year,month,day
	order by year
),
Q2 AS(
	SELECT DISTINCT year,month,MIN(TOTAL_Q) AS SLOWEST_Q,MAX(TOTAL_Q) AS BUSIEST_Q
	FROM Q1
	GROUP BY year,month
	order by year,month
),
Q3 AS(
	SELECT Q2.year,Q2.month,Q1.day AS SLOWEST_DAY,Q2.SLOWEST_Q AS SLOWEST_TOTAL_Q
	FROM Q1,Q2
	WHERE Q2.SLOWEST_Q=Q1.TOTAL_Q AND Q2.year=Q1.year AND Q2.month = Q1.month
	ORDER BY Q2.year,Q2.month
),
Q4 AS(
	SELECT Q2.year,Q2.month,Q1.day AS BUSIEST_DAY,Q2.BUSIEST_Q AS BUSIEST_TOTAL_Q
	FROM Q1,Q2
	WHERE Q2.BUSIEST_Q=Q1.TOTAL_Q AND Q2.year=Q1.year AND Q2.month = Q1.month
	ORDER BY Q2.year,Q2.month
)
SELECT Q3.*,Q4.BUSIEST_DAY,Q4.BUSIEST_TOTAL_Q
FROM Q3,Q4
WHERE Q3.year=Q4.year AND Q3.month=Q4.month
ORDER BY Q3.year,Q3.month;

--------------------- Query 3 

WITH Q1 AS(
	SELECT cust,month,prod,SUM(quant) AS PROD_Q
	FROM sales
	GROUP BY cust,month,prod
	ORDER BY cust,month
),
Q2 AS(
	SELECT cust,month,MAX(PROD_Q) AS MOST_FAV,MIN(PROD_Q) AS LEAST_FAV
	FROM Q1
	GROUP BY cust,month
	ORDER BY cust,month
),
Q3 AS(
	SELECT Q1.cust,Q1.month,Q1.prod AS MOST_FAV_PROD
	FROM Q1,Q2
	WHERE Q1.cust=Q2.cust AND Q1.month=Q2.month AND Q1.PROD_Q=Q2.MOST_FAV
	ORDER BY Q1.cust,Q1.month
),
Q4 AS(
	SELECT Q1.cust,Q1.month,Q1.prod AS LEAST_FAV_PROD
	FROM Q1,Q2
	WHERE Q1.cust=Q2.cust AND Q1.month=Q2.month AND Q1.PROD_Q=Q2.LEAST_FAV
	ORDER BY Q1.cust,Q1.month
)
SELECT Q3.*,Q4.LEAST_FAV_PROD
FROM Q3,Q4
WHERE Q3.cust=Q4.cust AND Q3.month=Q4.month
ORDER BY Q3.cust,Q3.month;

--------------------- Query 4 
	
WITH MAIN AS(
	SELECT cust AS CUSTOMER,prod AS PRODUCT,ROUND(AVG(quant),0) AS AVERAGE,SUM(quant) AS TOTAL,COUNT(quant) as COUNT
  	FROM sales
  	GROUP BY cust,prod
  	ORDER BY cust
),
QUATER_1 AS (
	SELECT cust AS CUSTOMER,prod AS PRODUCT,ROUND(AVG(quant),0) AS Q1_AVG
  	FROM sales
	WHERE month BETWEEN 1 AND 3
  	GROUP BY cust,prod
  	ORDER BY cust
),
QUATER_2 AS (
	SELECT cust AS CUSTOMER,prod AS PRODUCT,ROUND(AVG(quant),0) AS Q2_AVG
  	FROM sales
	WHERE month BETWEEN 4 AND 6
  	GROUP BY cust,prod
  	ORDER BY cust
),
QUATER_3 AS (
	SELECT cust AS CUSTOMER,prod AS PRODUCT,ROUND(AVG(quant),0) AS Q3_AVG
  	FROM sales
	WHERE month BETWEEN 7 AND 9
  	GROUP BY cust,prod
  	ORDER BY cust
),
QUATER_4 AS (
	SELECT cust AS CUSTOMER,prod AS PRODUCT,ROUND(AVG(quant),0) AS Q4_AVG
  	FROM sales
	WHERE month BETWEEN 10 AND 12
  	GROUP BY cust,prod
  	ORDER BY cust
)
SELECT MAIN.CUSTOMER,MAIN.PRODUCT,QUATER_1.Q1_AVG,QUATER_2.Q2_AVG,QUATER_3.Q3_AVG,
	   QUATER_4.Q4_AVG,MAIN.AVERAGE,MAIN.TOTAL,MAIN.COUNT
FROM MAIN,QUATER_1,QUATER_2,QUATER_3,QUATER_4
WHERE MAIN.PRODUCT = QUATER_1.PRODUCT AND MAIN.CUSTOMER = QUATER_1.CUSTOMER AND
	  MAIN.PRODUCT = QUATER_2.PRODUCT AND MAIN.CUSTOMER = QUATER_2.CUSTOMER AND
	  MAIN.PRODUCT = QUATER_3.PRODUCT AND MAIN.CUSTOMER = QUATER_3.CUSTOMER AND
	  MAIN.PRODUCT = QUATER_4.PRODUCT AND MAIN.CUSTOMER = QUATER_4.CUSTOMER;

--------------------- Query 5

WITH MAIN AS(
	SELECT prod AS PRODUCT,SUM(quant) AS TOTAL
	FROM sales
  	GROUP BY prod
  	ORDER BY prod
),
QUATER_1 AS (
	SELECT prod AS PRODUCT,SUM(quant) AS Q1_QUANT,date
  	FROM sales
	WHERE month BETWEEN 1 AND 3
  	GROUP BY prod,date
  	ORDER BY prod
),
QUATER_2 AS (
 	SELECT prod AS PRODUCT,SUM(quant) AS Q2_QUANT,date
 	FROM sales
 	WHERE month BETWEEN 4 AND 6
   	GROUP BY prod,date
  	ORDER BY prod
),
QUATER_3 AS (
 	SELECT prod AS PRODUCT,SUM(quant) AS Q3_QUANT,date
   	FROM sales
 	WHERE month BETWEEN 7 AND 9
   	GROUP BY prod,date
  	ORDER BY prod
),
QUATER_4 AS (
 	SELECT prod AS PRODUCT,SUM(quant) AS Q4_QUANT,date
   	FROM sales
 	WHERE month BETWEEN 10 AND 12
    GROUP BY prod,date
  	ORDER BY prod
),
QUATER_1_MAX AS (
	SELECT PRODUCT,MAX(Q1_QUANT) AS Q1_MAX
  	FROM QUATER_1
	GROUP BY PRODUCT
	ORDER BY PRODUCT
),
QUATER_2_MAX AS (
	SELECT PRODUCT,MAX(Q2_QUANT) AS Q2_MAX
  	FROM QUATER_2
	GROUP BY PRODUCT
	ORDER BY PRODUCT
),
QUATER_3_MAX AS (
	SELECT PRODUCT,MAX(Q3_QUANT) AS Q3_MAX
  	FROM QUATER_3
	GROUP BY PRODUCT
	ORDER BY PRODUCT
),
QUATER_4_MAX AS (
	SELECT PRODUCT,MAX(Q4_QUANT) AS Q4_MAX
  	FROM QUATER_4
	GROUP BY PRODUCT
	ORDER BY PRODUCT
),
QUATER_1_MAX_DATE AS (
	SELECT QUATER_1_MAX.PRODUCT,QUATER_1_MAX.Q1_MAX,QUATER_1.date
  	FROM QUATER_1,QUATER_1_MAX
	WHERE QUATER_1.PRODUCT = QUATER_1_MAX.PRODUCT AND
		  QUATER_1.Q1_QUANT = QUATER_1_MAX.Q1_MAX
),
QUATER_2_MAX_DATE AS (
	SELECT QUATER_2_MAX.PRODUCT,QUATER_2_MAX.Q2_MAX,QUATER_2.date
  	FROM QUATER_2,QUATER_2_MAX
	WHERE QUATER_2.PRODUCT = QUATER_2_MAX.PRODUCT AND
		  QUATER_2.Q2_QUANT = QUATER_2_MAX.Q2_MAX
),
QUATER_3_MAX_DATE AS (
	SELECT QUATER_3_MAX.PRODUCT,QUATER_3_MAX.Q3_MAX,QUATER_3.date
  	FROM QUATER_3,QUATER_3_MAX
	WHERE QUATER_3.PRODUCT = QUATER_3_MAX.PRODUCT AND
		  QUATER_3.Q3_QUANT = QUATER_3_MAX.Q3_MAX
),
QUATER_4_MAX_DATE AS (
	SELECT QUATER_4_MAX.PRODUCT,QUATER_4_MAX.Q4_MAX,QUATER_4.date
  	FROM QUATER_4,QUATER_4_MAX
	WHERE QUATER_4.PRODUCT = QUATER_4_MAX.PRODUCT AND
		  QUATER_4.Q4_QUANT = QUATER_4_MAX.Q4_MAX
)
SELECT MAIN.PRODUCT,QUATER_1_MAX_DATE.Q1_MAX,QUATER_1_MAX_DATE.date,QUATER_2_MAX_DATE.Q2_MAX,QUATER_2_MAX_DATE.date,QUATER_3_MAX_DATE.Q3_MAX,
	   QUATER_3_MAX_DATE.date,QUATER_4_MAX_DATE.Q4_MAX,QUATER_4_MAX_DATE.date
FROM MAIN,QUATER_1_MAX_DATE,QUATER_2_MAX_DATE,QUATER_3_MAX_DATE,QUATER_4_MAX_DATE
WHERE MAIN.PRODUCT = QUATER_1_MAX_DATE.PRODUCT AND
	  MAIN.PRODUCT = QUATER_2_MAX_DATE.PRODUCT AND
	  MAIN.PRODUCT = QUATER_3_MAX_DATE.PRODUCT AND
	  MAIN.PRODUCT = QUATER_4_MAX_DATE.PRODUCT;

 
